<!DOCTYPE html>
<!--[if lt IE 7]> <html lang="en" class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]> <html lang="en" class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]> <html lang="en" class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">

  <title>Refugios Temporales | Municipio de Centro</title>
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <meta content="" name="description">
  <meta content="logydes.com.mx" name="author">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="css/style-t1.css" rel="stylesheet">




  <link href="ico/favicon.ico" rel="shortcut icon">
  <link href="ico/apple-touch-icon.png" rel="apple-touch-icon">
  <link href="ico/apple-touch-icon-72x72.png" rel="apple-touch-icon" sizes="72x72">
  <link href="ico/apple-touch-icon-114x114.png" rel="apple-touch-icon" sizes="114x114">

    <style type="text/css">
        .alaPar{display: inline-block; vertical-align: top;}
        .mr-2{margin-right: 2em !important;}
        .mt-05{margin-top: 0.5em !important; }
    </style>

</head>
<body >
<!-- .................................... $header .................................... -->
<header class="navbar-fixed-top" style="background-color: #822B30 !important;">
    <div class="navbar" style="background-color: #822B30 !important;">
        <div class="navbar-inner" style="background-color: #822B30 !important;">
            <ul class="nav navbar-nav pull-left" style="background-color: #822B30 !important;">
                <!-- <li ><a  href="#" id="trazarRuta">Trazar Ruta</a></li> -->
                <li ><a  href="#" id="filtrarRuta">Filtrar Ruta</a></li>
                <li ><a  href="#" id="showScreenUbiRef">Ubica tu Refugio</a></li>
                <li ><a href="/"><span class="badge">MAPA DE UBICACION DE REFUGIOS TEMPORALES</span></a></li>
                <li id="barda"></li>
            </ul>
            <div class="pull-right mr-2 mt-05 " style="height: 40px !important;" ><a href="https:villahermosa.gob.mx"><img src="images/logo_centro_80_pixeles_002.png" height="20" style="height:40px !important;"> </img></a></div>
        </div>
    </div>
</header>
<h6> </h6>


  <!-- .................................... $Portfolio .................................... -->
 <div class="container">

 <!-- Modal -->
  <!-- <div class="modal fade hide" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
          <h4 class="modal-title">Trazar Ruta</h4>
        </div>
        <div class="modal-body">

            <form class="navbar-form navbar-left" id="frmFiltrar" >
                  <div class="form-group">
                    <select id="desde" name="desde" size="1" ></select>
                  </div>
                  <div class="form-group">
                    <select id="hasta" name="hasta" size="1" ></select>
                  </div>
                  <div class="form-group">
                    <span>En </span>
                    <select id="drive" name="drive" size="1" >
                        <option value="0" selected >Automóvil</option>
                        <option value="1">Caminando</option>
                    </select>
                  </div>
            </form>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
          <button type="button" class="btn btn-primary" id="btnTrazar">Aceptar</button>
        </div>
      </div>
    </div>
  </div>
-->

<!-- Modal -->
  <div class="modal fade hide" id="myRuta" tabindex="-2" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
          <h4 class="modal-title">Filtrar Ruta</h4>
        </div>
        <div class="modal-body">

            <form class="navbar-form navbar-left" id="frmFiltrar" >
                  <div class="form-group">
                    <select id="refujiorutaid" name="refujiorutaid" size="1" placeholder="Mundo"></select>
                  </div>
            </form>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
          <button type="button" class="btn btn-primary" id="btnFiltrar">Aceptar</button>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->




 <!-- Modal -->
  <div class="modal fade hide" id="myModalUbiRef" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
          <h4 class="modal-title">Ubica tu Refugio</h4>
        </div>
        <div class="modal-body">

            <div class="span4">
                <div class="panel panel-success">
                  <div class="panel-body">
                        <label for="selCombo0" class="lblH2cmb">1.- Selecciona el Tipo de Comunidad donde vives </label>
                        <select name="selCombo0" class="span3" size="1" >
                        </select>
                        <label for="listDesde0" class="lblH2">2.- Selecciona tu Comunidad</label>
                        <select class="listDesde0 span3" name="listDesde0" size="1" > </select>
                   </div>
                </div>
            </div>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
          <button type="button" class="btn btn-primary" id="btnUbiRef">Aceptar</button>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->






 </div><!-- container -->

 <div class="container" id="contTolTip">

</div>

  <!-- .................................... $MAP on background .................................... -->
  <section>

    <div  id="preloader"  class="container" style="padding-bottom: 1em;">
      <img src="assets/img/loading.gif" width="16" height="16" alt=""> Cargando...
    </div>

    <div  id="mapDen"  class="map map-background"></div>



  </section>

  <!-- .................................... $post-footer .................................... -->
  <div class="post-footer section-content section-content-mini section-color-graydark">
    <div class="container">
      <p class="pull-right">
        CMI |
        <a href="https://villahermosa.gob.mx" title="Coordinación de Modernización e Innovación">villahermnosa.gob.mx</a>
      </p>
      <p>H. Ayuntamiento Constitucional de Centro - 2024 &copy;  Todos los derechos reservados</p>
    </div>
  </div>


 <!-- Modal -->

  <!-- .................................... $scripts .................................... -->
  <script src="js/libs/jquery.min.js"></script>
  <script src="bootstrap/js/bootstrap.min.js"></script>
  <script src="bootstrap/js/dropdown.js"></script>
  <script src="js/script.js"></script>

  <script src="js/libs/modernizr.min.js"></script>
  <script  src="js/01/base.js"></script>
  <script  src="js/init.js"></script>

  <!-- <script type="text/javascript" src="http://www.google.com/jsapi"></script>
  <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=true&libraries=weather"></script>  -->


<script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>

<script
  src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=true&libraries=weather&key=AIzaSyB0mmrw3wLssGqd1eUKWAH43GEcn5bm8-s&callback=initMap&v=weekly"
></script>



  <script>
var urlBase = "http://localhost:8000/"; //obj.getValue(0);
var beaches = [];
var queryString = " where latitud > 0 ";
var lat;
var lon;
var directionsDisplay;
var directionsService = new google.maps.DirectionsService();
var map;

var initRuta
var finRuta;
var latlngClient="";

var rendererOptions;

function init(){
    //map  = null;

	var tM = google.maps.MapTypeId.ROADMAP;

	var latlng = new google.maps.LatLng(lat,lon);
	var myOptions = {
	    zoom: 11,
	    center: latlng,
	    mapTypeControl: false,
        sensor:true,
	    mapMaker:true,
	    navigationControlOptions: {style: google.maps.NavigationControlStyle.DROP},
	    mapTypeId: tM
	};

    setTolTip();
    //map  = null;



	map = new google.maps.Map(document.getElementById("mapDen"), myOptions);



     var weatherLayer = new google.maps.weather.WeatherLayer({
        temperatureUnits: google.maps.weather.TemperatureUnit.CELSIUS,
        windSpeedUnit: google.maps.weather.WindSpeedUnit.KILOMETERS_PER_HOUR
      });
      weatherLayer.setMap(map);

      var cloudLayer = new google.maps.weather.CloudLayer();
      cloudLayer.setMap(map);



    var MarkerInit;
    for (var i = 0; i < beaches.length; i++) {
        var beach = beaches[i];
        //alert(beach[14]);
        if (beach[14]!=null){

            var myLatLng = new google.maps.LatLng(beach[1], beach[2]);
            var img;
            //alert(beach[14]);
            if (beach[14]=="RURAL"){
                img = 'images/z2.png';
            }else{
                img = 'images/z1.png';
            }

            var image = {
                        url: img,
                        size: new google.maps.Size(28, 34),
                        origin: new google.maps.Point(0,0),
                        anchor: new google.maps.Point(0, 34)
                        };
            var shape = {
                  coord: [1, 1, 1, 20, 18, 20, 18 , 1],
                  type: 'poly'
            };

    		var marker = new google.maps.Marker({
    		    position: myLatLng,
    		    map: map,
    		    optimized:false,
                animation: google.maps.Animation.DROP,
                icon: image,
                shape: shape,
    		    visible:true,
                title: beach[0]+".\nHaz click para ver los detalles",
                zIndex: i

    		  });

            if (i==0){
                MarkerInit = marker;
                initRuta = myLatLng;
            }

            finRuta = myLatLng;

            attachSecretMessage(marker, beach[4]);
        }
    }



    function attachSecretMessage(marker, number) {
      var message = $("#ref-"+number).html();
      var infowindow = new google.maps.InfoWindow(
          { content: message

          });
      google.maps.event.addListener(marker, 'click', function() {
        infowindow.open(map,marker);
      });
    }


    rendererOptions = {
        map: map
    }

    map.setCenter(MarkerInit.getPosition());
    directionsDisplay = new google.maps.DirectionsRenderer(rendererOptions);

    directionsDisplay.setMap(map);


        //alert("5");
    $("#preloader").hide();

}

function getDatas(tipo, url){
    beaches = [];
    // alert(url);
    $.get("https://refugios.villahermosa.gob.mx:445/refugiospublic", {  },
        function(json){
            if (json.mensaje == "OK") {

                $.each(json.data, function(i, item) {

                    var LL = new google.maps.LatLng(item.latitud, item.longitud);
                   // alert(LL);
                    beaches.push([item.refugio,item.latitud,item.longitud,item.refujiorutaid,item.id,item.ubicacion_google,LL,
                                    item.telefonos,item.capacidad,item.enlace,item.ubicacion,item.observaciones,item.numero,item.ruta,
                                    item.zona,item.infraestructura, item.imagen]);
                    if(i==0){
                        lat = item.latitud;
                        lon = item.longitud;
                    }

                });
            }else{
                alert(json.mensaje);
            }
            getRefugio();
            init();
    }, "json");
}


function calcRoute() {
    directionsDisplay = new google.maps.DirectionsRenderer(rendererOptions);
    directionsDisplay.setMap(map);

    var travelMode;

    if ($("#drive").val()=="0"){
        travelMode = google.maps.TravelMode.DRIVING;
    }else{
        travelMode = google.maps.TravelMode.WALKING;
    }

    var start = initRuta;
    var end = finRuta;
    var request = {
        origin:start,
        destination:end,
        optimizeWaypoints: true,
        travelMode: travelMode
    };
    directionsService.route(request, function(result, status) {
    if (status == google.maps.DirectionsStatus.OK) {
        directionsDisplay.setDirections(result);

        var warnings = document.getElementById("barda");
              warnings.innerHTML = "" + response.routes[0].warnings + "";
              directionsDisplay.setDirections(response);
              showSteps(response);
    }
  });
}

function showSteps(directionResult) {
  var myRoute = directionResult.routes[0].legs[0];

  for (var i = 0; i < myRoute.steps.length; i++) {
      var marker = new google.maps.Marker({
        position: myRoute.steps[i].start_point,
        map: map
      });
      attachInstructionText(marker, myRoute.steps[i].instructions);
      markerArray[i] = marker;
  }
}

function attachInstructionText(marker, text) {
  google.maps.event.addListener(marker, 'click', function() {
    stepDisplay.setContent(text);
    stepDisplay.open(map, marker);
  });
}



getDatas(8, urlBase+'refugiospublic');

function getRutas(){
    $('select[name="refujiorutaid"]').empty();
    $('select[name="refujiorutaid"]').append('<option value="0"  >Filtrar una Ruta</option>');
    $.get("https://refugios.villahermosa.gob.mx:445/getrutas", {  },
        function(json){
            if (json.data.length > 0) {
                $.each(json.data, function(i, item) {
                    $('select[name="refujiorutaid"]').append('<option value="'+item.id+'"  >'+item.ruta+'</option>');
                });
            }
    }, "json");

}

function getRefugio(){



    $('select[name="desde"]').empty();
    $('select[name="hasta"]').empty();

    $('select[name="desde"]').append('<option value="0"  >Ir Desde</option>');
    if (latlngClient!=""){
        $('select[name="desde"]').append('<option value="'+latlngClient+'"  >Ubicación Actual</option>');
    }

    $('select[name="hasta"]').append('<option value="0"  >Hasta</option>');


    for (var i = 0; i < beaches.length; i++) {
        var beach = beaches[i];
        //alert(beach[6]);
        $('select[name="desde"]').append('<option value="'+beach[6]+'"  >'+beach[0]+'</option>');
        $('select[name="hasta"]').append('<option value="'+beach[6]+'"  >'+beach[0]+'</option>');
    }
}

function setTolTip(){
    var beach;
    for (var i = 0; i < beaches.length; i++) {
        beach = beaches[i];
        //alert(beach[12]);
        var str = "";


        str += '<div class="panel panel-primary hide" id="ref-'+beach[4]+'" >';
        str += '<div class="panel-heading">';
        str += '<h3 class="panel-title">'+beach[0]+'</h3>';
        str += '</div>';
        str += '<div class="panel-body">';
        str += '<div class="alaPar">';
        str += '<dl class="dl-horizontal">';
        str += '<dt>Imagen:</dt>';
        str += '<dd><img src="images/'+beach[16]+'" />';
        str += '<dt>Ruta:</dt>';
        str += '<dd>('+beach[12]+') '+beach[13]+', '+beach[14]+'</dd>';
        str += '<dt>Ubicación:</dt>';
        str += '<dd>'+beach[10]+'</dd>';
        str += '<dt>Enlace:</dt>';
        str += '<dd>'+beach[9]+'</dd>';
        str += '<dt>Capacidad:</dt>';
        str += '<dd>'+beach[8]+'</dd>';
        str += '<dt>Infraestructura:</dt>';
        str += '<dd>'+beach[15]+'</dd>';
        str += '<dt>Teléfono(s):</dt>';
        str += '<dd>'+beach[7]+'</dd>';
        str += '<dt>Observaciones:</dt>';
        str += '<dd>'+beach[11]+'</dd>';
        str += '</dl>';
        str += '</div>';
        str += '</div>';
        str += '</div>';


    $("#contTolTip").append(str);

   }

}


getRutas();


$("#trazarRuta").on("click",function(event){
    $('#myModal').modal();
});

$("#filtrarRuta").on("click",function(event){
    $('#myRuta').modal();
});


$("#showScreenUbiRef").on("click",function(event){
    $('#myModalUbiRef').modal();
});

$.post(urlBase+"getEC/", { o:300, t:1, p:0,c:"" },
    function(json){
        //alert(json.length);
       $("select[name=selCombo0]").append('<option value="0">Seleccione una opción</option>');
        if (json.length<=0) { return false;}
        $.each(json, function(i, item) {
            $("select[name=selCombo0]").append('<option value="'+item.data+'">'+item.label+'</option>');
        });
}, "json");

$("select[name=selCombo0]").on("change",function(event){
  event.preventDefault();
    var queryString = " idtipocomun = "+$(this).val();
    // alert(queryString);
    $.post(obj.getValue(0)+"getEC/", { o:300, t:2, p:0,c:queryString },
        function(json){
          // alert(json.length);
            $("select[name=listDesde0]").empty();
            if (json.length<=0) { return false; }
            $.each(json, function(i, item) {
                $("select[name=listDesde0]").append('<option value="'+item.data+'">'+item.label+'</option>');
            });
    }, "json");
});


$("#btnFiltrar").on("click",function(event){
    $('#myRuta').modal('hide');

    $("select[name=listDesde]")

    switch( parseInt($("#refujiorutaid").val()) ){
      case 0:
            queryString = "where latitud != 0 and activado = 1 ";
            url = urlBase+"refugiospublic";
            break;
      case -1:
            queryString = "where numero in (4,10,119,117,131,136) and activado = 1 ";
            break;
      default:
            queryString = "refujiorutaid = "+$("#refujiorutaid").val();
            url = urlBase+"refugiosporruta/"+$("#refujiorutaid").val();
            break;
    }
    getDatas(8,url);
});


$("#btnTrazar").on("click",function(event){
    $('#myModal').modal('hide');
    initRuta = $("#desde").val();
    finRuta = $("#hasta").val();

    if (initRuta=="0"){
        alert("Seleccione una Ruta de Inicio")
        $("#desde").focus();
        return false;
    }

    if (finRuta=="0"){
        alert("Seleccione una Ruta de Destino")
        $("#hasta").focus();
        return false;
    }

    calcRoute();
});




$("#btnUbiRef").on("click",function(event){
    $('#myModalUbiRef').modal('hide');

    var idcol1 = $("select[name=listDesde0]").val()

    queryString = "where idcol1 = "+idcol1+" and activado = 1 ";
    getDatas(9,urlBase+'refugiospublic');
});


function initialize() {
  if(navigator.geolocation) {

    navigator.geolocation.getCurrentPosition(function(position) {
      latlngClient = new google.maps.LatLng(position.coords.latitude,position.coords.longitude);
      //alert(latlngClient);
    });
     //alert(navigator.geolocation.getCurrentPosition());
  } else {
    // Browser doesn't support Geolocation
    handleNoGeolocation(false);
  }
}

function handleNoGeolocation(errorFlag) {
  if (errorFlag) {
    alert('Error: El servicio de Geolocalización ha fallado');
  } else {
    alert('Error: Tu navegador no soporta geolocalización');
  }


}




google.maps.event.addDomListener(window, 'load', initialize);



</script>






</body>
</html>
